<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Location & Radius Picker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body { height:100%; margin:0; font-family: system-ui, Arial; }
    #map { height: 65vh; }
    .panel { padding:12px; display:grid; gap:10px; }
    .row { display:flex; align-items:center; gap:12px; }
    input[type=range]{ flex:1; }
    button{ width:100%; padding:12px; border:0; border-radius:10px; font-weight:700; background:#2e9afe; color:#fff; cursor:pointer; }
    .hint{ font-size:12px; color:#666; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <div class="row">
      <label>Radius: <b><span id="rLabel">3</span> km</b></label>
      <input id="r" type="range" min="0.5" max="25" step="0.5" value="3">
    </div>
    <button id="send">✅ Send selection</button>
    <div class="hint">Tip: click the map or drag the pin to set the center. Move the slider to change the radius.</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Telegram WebApp API (works only inside Telegram; outside we use a fallback)
    const tg = window.Telegram?.WebApp;
    tg?.expand(); // use full screen in Telegram

    // Initialize Leaflet map
    const map = L.map('map').setView([52.5200, 13.4050], 12); // default: Berlin
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Ensure proper sizing after load (sometimes needed in WebApps)
    setTimeout(() => map.invalidateSize(), 200);

    // Pin + circle logic
    let radiusKm = 3.0;
    const marker = L.marker(map.getCenter(), { draggable: true }).addTo(map);
    let circle = L.circle(marker.getLatLng(), { radius: radiusKm * 1000 }).addTo(map);

    function redraw() {
      circle.setLatLng(marker.getLatLng());
      circle.setRadius(radiusKm * 1000);
    }

    marker.on('dragend', redraw);
    map.on('click', (e) => { marker.setLatLng(e.latlng); redraw(); });

    // Optional: start at user’s GPS
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 13);
        marker.setLatLng([latitude, longitude]);
        redraw();
      });
    }

    // Radius slider
    const rInput = document.getElementById('r');
    const rLabel = document.getElementById('rLabel');
    rInput.addEventListener('input', () => {
      radiusKm = parseFloat(rInput.value);
      rLabel.textContent = radiusKm;
      redraw();
    });

    // Send result
    document.getElementById('send').addEventListener('click', () => {
      const { lat, lng } = marker.getLatLng();
      const payload = {
        lat: Number(lat.toFixed(6)),
        lng: Number(lng.toFixed(6)),
        radius_km: Number(radiusKm.toFixed(1))
      };
      if (tg) {
        // Inside Telegram: send to the bot as web_app_data
        tg.sendData(JSON.stringify(payload));
        tg.close();
      } else {
        // Outside Telegram (browser test): copy to clipboard + alert
        navigator.clipboard?.writeText(JSON.stringify(payload));
        alert('Payload: ' + JSON.stringify(payload));
      }
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Location & Radius</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Arial}
    #map{height:65vh}
    .panel{padding:12px;display:grid;gap:10px}
    .row{display:flex;align-items:center;gap:12px}
    input[type=range]{flex:1}
    button{width:100%;padding:12px;border:0;border-radius:10px;font-weight:700;background:#2e9afe;color:#fff;cursor:pointer}
    .hint{font-size:12px;color:#666}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <div class="row">
      <label>Radius: <b><span id="rLabel">3</span> km</b></label>
      <input id="r" type="range" min="0.5" max="25" step="0.5" value="3">
    </div>
    <button id="send">✅ Send selection</button>
    <div class="hint">Click the map or drag the pin to set the center (default: Berlin).</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Telegram WebApp API
    const tg = window.Telegram?.WebApp; tg?.expand();

    // --- Fixed Berlin defaults ---
    const BERLIN = { lat: 52.520008, lng: 13.404954, zoom: 12 };

    // Map
    const map = L.map('map').setView([BERLIN.lat, BERLIN.lng], BERLIN.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap'
    }).addTo(map);
    // Make sure Leaflet sizes correctly inside Telegram webview
    setTimeout(()=>map.invalidateSize(), 200);

    // Pin + circle
    let radiusKm = 3.0;
    const marker = L.marker([BERLIN.lat, BERLIN.lng], { draggable:true }).addTo(map);
    let circle = L.circle([BERLIN.lat, BERLIN.lng], { radius: radiusKm*1000 }).addTo(map);

    function redraw(){
      circle.setLatLng(marker.getLatLng());
      circle.setRadius(radiusKm*1000);
    }

    marker.on('dragend', redraw);
    map.on('click', e => { marker.setLatLng(e.latlng); redraw(); });

    // DO NOT auto-jump to user geolocation (keeps default in Berlin)
    // If you ever want to use geolocation, uncomment below:
    /*
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 13);
        marker.setLatLng([latitude, longitude]); redraw();
      });
    }
    */

    // Radius slider
    const rInput = document.getElementById('r');
    const rLabel = document.getElementById('rLabel');
    rInput.addEventListener('input', ()=>{
      radiusKm = parseFloat(rInput.value);
      rLabel.textContent = radiusKm;
      redraw();
    });

    // Send ONLY lat/lng/radius_km back to Telegram bot
    document.getElementById('send').addEventListener('click', ()=>{
      const { lat, lng } = marker.getLatLng();
      const payload = {
        lat: Number(lat.toFixed(6)),
        lng: Number(lng.toFixed(6)),
        radius_km: Number(radiusKm.toFixed(1))
      };
      if (tg){
        tg.sendData(JSON.stringify(payload));
        tg.close();
      } else {
        // Fallback for browser testing outside Telegram
        navigator.clipboard?.writeText(JSON.stringify(payload));
        alert('Payload: ' + JSON.stringify(payload));
      }
    });
  </script>
</body>
</html>
